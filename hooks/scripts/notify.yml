---
- name: "Configurar notification no HCP Terraform (pre-plan)"
  hosts: localhost
  gather_facts: false

  vars:
    api_base: "https://app.terraform.io/api/v2"

    # Environment (Variable Set / pre-plan.sh)
    hcp_org: "{{ lookup('env', 'HCP_ORG') }}"
    hcp_token: "{{ lookup('env', 'HCP_TF_TOKEN') }}"
    ws_name: "{{ lookup('env', 'TFC_WORKSPACE_NAME') }}"

    # Liga o fluxo completo quando true (aceita WORKSPACE_NOTIFICATION_ENABLED ou workspace_notification_enabled)
    workspace_notification_enabled: "{{ (lookup('env','WORKSPACE_NOTIFICATION_ENABLED') or lookup('env','workspace_notification_enabled') or 'false') | bool }}"

    # Parâmetros da notification (sempre generic)
    notify_name: "{{ lookup('env', 'NOTIFY_NAME') | default('Generic webhook', true) }}"
    notify_url: "{{ lookup('env', 'NOTIFY_URL') | default('', true) }}"
    notify_triggers_raw: "{{ lookup('env', 'NOTIFY_TRIGGERS') | default('run:created,run:completed,run:errored', true) }}"

  tasks:
    - name: "Montar lista de triggers"
      set_fact:
        notify_triggers: "{{ notify_triggers_raw.split(',') | map('trim') | list }}"

    - name: "Checar URL (obrigatória para generic)"
      assert:
        that:
          - (notify_url | length) > 0
        fail_msg: "NOTIFY_URL é obrigatório para destination-type generic"

    - name: "Obter workspace (org + nome)"
      uri:
        url: "{{ api_base }}/organizations/{{ hcp_org }}/workspaces/{{ ws_name }}"
        method: GET
        headers:
          Authorization: "Bearer {{ hcp_token }}"
          Content-Type: "application/vnd.api+json"
        return_content: true
        status_code: [200]
      register: ws_resp

    - name: "Extrair workspace_id"
      set_fact:
        workspace_id: "{{ ws_resp.json.data.id }}"

    - name: "Listar notification-configurations do workspace"
      uri:
        url: "{{ api_base }}/workspaces/{{ workspace_id }}/notification-configurations"
        method: GET
        headers:
          Authorization: "Bearer {{ hcp_token }}"
          Content-Type: "application/vnd.api+json"
        return_content: true
        status_code: [200]
      register: list_resp

    - name: "Filtrar por nome + destination-type generic"
      set_fact:
        existing_nc: >-
          {{
            (list_resp.json.data | default([]))
            | selectattr('attributes.name', 'equalto', notify_name)
            | selectattr('attributes.destination-type', 'equalto', 'generic')
            | list
          }}

    # --- CREATE: sempre disabled (evita verify automático no POST) ---
    - name: "Criar notification generic se não existir"
      uri:
        url: "{{ api_base }}/workspaces/{{ workspace_id }}/notification-configurations"
        method: POST
        headers:
          Authorization: "Bearer {{ hcp_token }}"
          Content-Type: "application/vnd.api+json"
          Accept: "application/vnd.api+json"
        body_format: json
        body:
          data:
            type: "notification-configurations"   # PLURAL no create
            attributes:
              name: "{{ notify_name }}"
              enabled: false
              destination-type: "generic"
              url: "{{ notify_url }}"
              triggers: "{{ notify_triggers }}"
        return_content: true
        status_code: [201]
      register: create_resp
      when: (existing_nc | length) == 0

    - name: "Definir notification_id (novo ou existente)"
      set_fact:
        notification_id: "{{ (create_resp.json.data.id if (existing_nc | length) == 0 else existing_nc[0].id) }}"

    # --- PATCH para habilitar e alinhar atributos (somente quando enabled=true) ---
    - name: "Habilitar e ajustar atributos (PATCH)"
      uri:
        url: "{{ api_base }}/notification-configurations/{{ notification_id }}"
        method: PATCH
        headers:
          Authorization: "Bearer {{ hcp_token }}"
          Content-Type: "application/vnd.api+json"
          Accept: "application/vnd.api+json"
        body_format: json
        body:
          data:
            id: "{{ notification_id }}"
            type: "notification-configurations"
            attributes:
              name: "{{ notify_name }}"
              enabled: true
              destination-type: "generic"
              url: "{{ notify_url }}"
              triggers: "{{ notify_triggers }}"
        return_content: true
        status_code: [200]
      when: workspace_notification_enabled

    # --- VERIFY: aceita 200 ou 400 e não falha o run ---
    - name: "Verify (actions/verify) quando habilitado"
      uri:
        url: "{{ api_base }}/notification-configurations/{{ notification_id }}/actions/verify"
        method: POST
        headers:
          Authorization: "Bearer {{ hcp_token }}"
          Content-Type: "application/vnd.api+json"
          Accept: "application/vnd.api+json"
        body_format: json
        body:
          data:
            id: "{{ notification_id }}"
            type: "notification-configurations"
        return_content: true
        status_code: [200, 400]
      when: workspace_notification_enabled

    - name: "Resumo"
      debug:
        msg:
          - "workspace_id={{ workspace_id }}"
          - "notification_id={{ notification_id }}"
          - "name={{ notify_name }}"
          - "destination-type=generic"
          - "enabled_now={{ workspace_notification_enabled }}"
          - "triggers={{ notify_triggers }}"
